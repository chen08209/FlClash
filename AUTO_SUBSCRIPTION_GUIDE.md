# 自动获取订阅功能使用指南

## 功能说明
本功能实现了以下自动化功能：
1. **登录后自动添加订阅**：用户登录成功后，系统自动从服务器获取订阅并添加
2. **启动时自动更新**：应用启动时自动更新已存在的服务器订阅
3. **手动获取订阅**：保留手动从服务器获取订阅的选项

## 前提条件
1. 用户必须先登录账户（账户信息页面）
2. 服务器API必须返回有效的订阅链接

## 使用步骤

### 方式一：登录后自动添加（推荐）

1. **登录账户**
   - 打开应用，进入登录页面
   - 输入邮箱和密码登录
   - 登录成功后，系统会自动：
     - 获取订阅信息
     - 检查是否已存在订阅
     - 如果不存在，自动添加新订阅
     - 如果已存在，自动更新订阅
   - 无需任何手动操作

2. **应用启动自动更新**
   - 每次启动应用时
   - 系统会检查是否已登录
   - 如果已登录，自动更新服务器订阅
   - 保证配置始终是最新的

### 方式二：手动获取订阅

1. **确保已登录**
   - 打开应用，进入账户信息页面
   - 确认已登录账户

2. **添加订阅配置**
   - 进入"配置"页面
   - 点击右下角的"+"按钮
   - 选择第一项"自动获取订阅"
   - 系统会自动完成添加

3. **激活配置**
   - 添加成功后，点击新添加的配置以激活
   - 系统会应用该配置并启动代理服务

## API接口说明

### 获取订阅信息接口
- **URL**: `/api/v1/user/getSubscribe`
- **Method**: GET
- **Headers**: 需要包含 `authorization` 认证头
- **Response**:
```json
{
  "status": "success",
  "data": {
    "subscribe_url": "订阅链接URL",
    "plan": {
      "name": "套餐名称"
    },
    "token": "订阅token",
    // 其他订阅信息...
  }
}
```

## 错误处理

如果出现以下情况，系统会显示相应的错误提示：

1. **未登录**：提示"请先登录账户"
2. **API调用失败**：显示具体的错误信息
3. **未找到订阅链接**：提示"未找到订阅链接"
4. **配置验证失败**：显示验证错误信息

## 技术实现细节

### 相关文件修改
1. `lib/views/profiles/add_profile.dart` - 添加"自动获取订阅"选项
2. `lib/controller.dart` - 实现三个核心方法：
   - `addProfileFromApi()` - 手动获取订阅
   - `_autoUpdateServerSubscription()` - 启动时自动更新
3. `lib/pages/login_page.dart` - 登录成功后自动添加订阅
4. `lib/services/api_service_v2.dart` - API调用服务（已存在）
5. `lib/models/profile.dart` - 更新订阅时添加User-Agent: `clashmeta_huanshen`
6. `lib/common/request.dart` - 支持自定义User-Agent请求头

### 核心代码逻辑
```dart
addProfileFromApi() async {
  // 1. 检查登录状态
  // 2. 调用API获取订阅信息
  // 3. 提取订阅链接和套餐名称
  // 4. 创建并更新配置
  // 5. 添加到配置列表
  // 6. 显示操作结果
}
```

## 注意事项
- 该功能仅在安卓端实现和测试
- 确保网络连接正常
- 订阅链接必须是有效的Clash配置文件URL
- 配置文件会自动保存到本地
- 更新订阅时自动添加User-Agent: `clashmeta_huanshen`头部标识

## 更新日志
- 2024-01-23 v2.1: 为订阅更新请求添加特定的User-Agent标识
- 2024-01-23 v2.0: 完整实现登录后自动添加和启动时自动更新功能
- 2024-01-23 v1.0: 初始版本，实现手动获取订阅功能
